const ethUtil = require('ethereumjs-util');
var TestABI = artifacts.require('TestABI');

function myEcsign(messageHash, privateKey) {
    messageHash = Buffer.from(messageHash.substr(2), 'hex')
    let signatureObj = ethUtil.ecsign(messageHash, privateKey);
    let signatureHexString = ethUtil.toRpcSig(signatureObj.v, signatureObj.r, signatureObj.s).toString('hex');
    let signatureBytes = web3.utils.hexToBytes(signatureHexString);
    return signatureBytes;
}

contract('test abi encode', () => {
  const userPrivateKey = Buffer.from("d01a9956202e7b447ba7e00fe1b5ca8b3f777288da6c77831342dbd2cb022f8f", 'hex');

  it("should successfully", async(accounts) =>{
    let instance = await MessageDecoder.deployed();
    let sessionID = web3.utils.sha3("jjj");
    let balance = 1;
    let nonce = 8;
    let additionalHash = sessionID;
    let signature = myEcsign(sessionID, userPrivateKey);
    let dList = [];
    for(let i=0; i<10; i++){

    }  
    let res = await instance.exportSession(sessionID);
    console.log("export", typeof res);

    res = await instance.importSession(bb);
    console.log("import res", res);
    res = await instance.importedMessages.call(1);
    console.log("0", res);
    // res = await instance.importedMessages.call(1);
    // console.log("1", res);
  });

  // it("should successfully", async(accounts) =>{
  //   let instance = await MessageDecoder.deployed();
  //   let sessionID = web3.utils.sha3("jjj");
  //   let balance = 1;
  //   let nonce = 8;
  //   let additionalHash = sessionID;
  //   let signature = myEcsign(sessionID, userPrivateKey);
  //   for(let i=1; i<2; i++) {
  //     await instance.sendMessage("0xd099044e12af61733823161006AD70aB1fAB3635", "0xd099044e12af61733823161006AD70aB1fAB3635", sessionID, "xxoo", "0x0", "0x0", sessionID, balance, i, sessionID, signature);
  //   }
  //   // let res = await instance.messages.call(sessionID, 1);
  //   // console.log("export", res);    
  //   let res = await instance.exportSession(sessionID);
  //   console.log("export", typeof res);

  //   const bb = "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000d099044e12af61733823161006ad70ab1fab3635000000000000000000000000d099044e12af61733823161006ad70ab1fab3635ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000478786f6f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f175b34c5ae29e249fef08ef81208a2ca74b0343e345449bbdd418749cca6daa28eed1233bfc09017a7a1a9a55ed3d1c364704c7a612f328633fa3156274b6221c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000d099044e12af61733823161006ad70ab1fab3635000000000000000000000000d099044e12af61733823161006ad70ab1fab3635ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001ca960767026ab08a9d3c3e794608e6c27dbe9cfbdf6e14d2c492dcbe8a9012dc0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000478786f6f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041f175b34c5ae29e249fef08ef81208a2ca74b0343e345449bbdd418749cca6daa28eed1233bfc09017a7a1a9a55ed3d1c364704c7a612f328633fa3156274b6221c00000000000000000000000000000000000000000000000000000000000000"; 
  //   res = await instance.importSession(bb);
  //   console.log("import res", res);
  //   res = await instance.importedMessages.call(1);
  //   console.log("0", res);
  //   // res = await instance.importedMessages.call(1);
  //   // console.log("1", res);
  // });
});
